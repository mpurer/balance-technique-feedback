<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arm Height Detection MVP</title>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: sans-serif;
    }
    video, canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      transform: scaleX(-1); /* mirror selfie view */
    }
  </style>
</head>

<body>

  <!-- Required camera elements -->
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <!-- Mediapipe dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    console.log("Starting camera…");

    // -------------------------
    // 1. CAMERA INITIALIZATION
    // -------------------------
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" }   // Selfie camera for testing
    })
    .then(stream => {
      video.srcObject = stream;

      video.onloadeddata = () => {
        console.log("Camera loaded:", video.videoWidth, video.videoHeight);

        // Prevent zero-size video
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;

        startPoseDetection();
      };
    })
    .catch(err => {
      console.error("CAMERA ERROR:", err);
      alert("Camera blocked. Enable camera permissions in your device settings.");
    });

    // -------------------------
    // 2. START MEDIAPIPE POSE
    // -------------------------
    function startPoseDetection() {
      const pose = new Pose.Pose({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`
      });

      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      pose.onResults(onResults);

      console.log("Starting Mediapipe Camera…");

      const camera = new CameraUtils.Camera(video, {
        onFrame: async () => {
          if (video.videoWidth === 0) return;
          await pose.send({ image: video });
        },
        width: video.videoWidth,
        height: video.videoHeight
      });

      camera.start();
    }

    // -------------------------
    // 3. DRAWING + ARM LOGIC
    // -------------------------
    function onResults(results) {
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      if (results.poseLandmarks) {
        drawConnectors(ctx, results.poseLandmarks, Pose.POSE_CONNECTIONS);
        drawLandmarks(ctx, results.poseLandmarks);

        const leftWrist = results.poseLandmarks[15];
        const rightWrist = results.poseLandmarks[16];
        const leftShoulder = results.poseLandmarks[11];
        const rightShoulder = results.poseLandmarks[12];

        const leftStatus = leftWrist.y < leftShoulder.y ? "LEFT: ABOVE" : "LEFT: BELOW";
        const rightStatus = rightWrist.y < rightShoulder.y ? "RIGHT: ABOVE" : "RIGHT: BELOW";

        ctx.fillStyle = "yellow";
        ctx.font = "32px Arial";
        ctx.fillText(leftStatus, 20, 40);
        ctx.fillText(rightStatus, 20, 80);
      }

      ctx.restore();
    }
  </script>

</body>
</html>
